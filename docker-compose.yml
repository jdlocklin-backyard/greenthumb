version: '3.9'

# =============================================================================
# GreenThumb Platform - Docker Compose Configuration
# =============================================================================
# This configuration orchestrates a complete self-hosted gardening platform:
# - Traefik: Reverse proxy with automatic service discovery
# - PostgreSQL: Primary database with PostGIS extension
# - Redis: Cache and message broker for the agent
# - Backend: FastAPI application serving REST API
# - Agent: Autonomous worker for weather checks and data updates
# - Frontend: Next.js application with SSR support
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Traefik - Reverse Proxy & Load Balancer
  # ---------------------------------------------------------------------------
  # Handles routing to all services via Docker labels
  # Dashboard available at traefik.green.lab
  # ---------------------------------------------------------------------------
  traefik:
    image: traefik:v3.0
    container_name: greenthumb-traefik
    restart: unless-stopped
    command:
      # Enable Docker provider for automatic service discovery
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      
      # HTTP entrypoint (port 80)
      - "--entrypoints.web.address=:80"
      
      # Enable dashboard (secured by labels below)
      - "--api.dashboard=true"
      - "--api.insecure=false"
      
      # Logging
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
      - "--accesslog=true"
      
      # Metrics (optional)
      - "--metrics.prometheus=true"
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS (when SSL enabled)
    volumes:
      # Docker socket for service discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # ACME certificates (Let's Encrypt)
      - ./acme.json:/acme.json
    labels:
      # Enable Traefik for itself (dashboard)
      - "traefik.enable=true"

      # Dashboard routing via path (http://<IP>/traefik)
      - "traefik.http.routers.traefik.rule=PathPrefix(`/traefik`) || PathPrefix(`/api/traefik`)"
      - "traefik.http.routers.traefik.entrypoints=web"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.priority=100"

      # Strip prefix middleware
      - "traefik.http.middlewares.traefik-strip.stripprefix.prefixes=/traefik"

      # Basic auth for dashboard (generate: htpasswd -nb admin password)
      # Default: admin/admin (CHANGE THIS!)
      - "traefik.http.routers.traefik.middlewares=auth,traefik-strip"
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$H6uskkkW$$IgXLP6ewTrSuBkTrqE8wj/"
    networks:
      - greenthumb

  # ---------------------------------------------------------------------------
  # PostgreSQL - Primary Database with PostGIS
  # ---------------------------------------------------------------------------
  # Stores all application data (plants, gardens, users, locations)
  # PostGIS extension enabled for geospatial queries
  # ---------------------------------------------------------------------------
  postgres:
    image: postgis/postgis:16-3.4
    container_name: greenthumb-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      # Performance tuning for home lab (adjust based on RAM)
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 1GB
    volumes:
      # Persistent database storage
      - ./data/db:/var/lib/postgresql/data
      # Initialization scripts (run on first start)
      - ./backend/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - greenthumb
    # Not exposed externally - only accessible within Docker network

  # ---------------------------------------------------------------------------
  # Redis - Cache & Message Broker
  # ---------------------------------------------------------------------------
  # Used by agent for task locking and caching weather data
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: greenthumb-redis
    restart: unless-stopped
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      # Persistent Redis data
      - ./data/redis:/data
    healthcheck:
      # Fixed: Use proper ping command with authentication
      test: ["CMD-SHELL", "redis-cli -a $$REDIS_PASSWORD ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - greenthumb

  # ---------------------------------------------------------------------------
  # Backend API - FastAPI Application
  # ---------------------------------------------------------------------------
  # REST API for all application operations
  # Swagger UI available at /docs
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: greenthumb-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      # Override for container networking
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
    volumes:
      # Mount source code for development (comment out for production)
      - ./backend:/app
      # Logs volume
      - ./logs/backend:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      # Enable Traefik routing
      - "traefik.enable=true"

      # API routing via path (http://<IP>/api)
      - "traefik.http.routers.backend.rule=PathPrefix(`/api`)"
      - "traefik.http.routers.backend.entrypoints=web"
      - "traefik.http.routers.backend.priority=90"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"

      # CORS middleware (allow all origins for local dev)
      - "traefik.http.middlewares.backend-cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,PATCH,OPTIONS"
      - "traefik.http.middlewares.backend-cors.headers.accesscontrolalloworiginlist=*"
      - "traefik.http.middlewares.backend-cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.backend-cors.headers.addvaryheader=true"

      - "traefik.http.routers.backend.middlewares=backend-cors"
    networks:
      - greenthumb

  # ---------------------------------------------------------------------------
  # Agent - Autonomous Worker
  # ---------------------------------------------------------------------------
  # Scheduled tasks:
  # - Weather data collection (Open-Meteo API)
  # - Seed database updates (OpenFoodFacts API)
  # - Plant care reminders
  # ---------------------------------------------------------------------------
  agent:
    build:
      context: ./agent
      dockerfile: Dockerfile
    container_name: greenthumb-agent
    restart: unless-stopped
    env_file:
      - .env
    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
    volumes:
      # Mount source code for development
      - ./agent:/app
      # Logs volume (JSON format for easy parsing)
      - ./logs/agent:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      backend:
        condition: service_healthy
    networks:
      - greenthumb

  # ---------------------------------------------------------------------------
  # Frontend - Next.js Application
  # ---------------------------------------------------------------------------
  # Server-side rendered React application
  # Available at green.lab
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      # Pass build args for API URL
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    container_name: greenthumb-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    # volumes:
      # Mount for development hot reload (uncomment for development)
      # - ./frontend:/app
      # - /app/node_modules
      # - /app/.next
    depends_on:
      - backend
    labels:
      # Enable Traefik routing
      - "traefik.enable=true"

      # Frontend routing (catch-all, lowest priority)
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.priority=1"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"

      # Compression middleware
      - "traefik.http.middlewares.frontend-compress.compress=true"
      - "traefik.http.routers.frontend.middlewares=frontend-compress"
    networks:
      - greenthumb

# =============================================================================
# Networks
# =============================================================================
networks:
  greenthumb:
    name: greenthumb
    driver: bridge

# =============================================================================
# Volumes (named volumes as alternative to bind mounts)
# =============================================================================
# Uncomment if you prefer named volumes over bind mounts
# volumes:
#   postgres_data:
#   redis_data:
